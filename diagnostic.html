<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Connection Diagnostic</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: bold;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      input {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 300px;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .form-group {
        margin: 15px 0;
      }
      label {
        display: inline-block;
        width: 100px;
        font-weight: bold;
      }
      .test-info {
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Socket.IO Connection Diagnostic</h1>

      <div class="test-info">
        <h3>üéØ Connection Test for Remote Server</h3>
        <p>This page helps diagnose Socket.IO connection issues to remote servers.</p>
        <p><strong>Common Issues:</strong></p>
        <ul>
          <li>Server not running on the specified port</li>
          <li>Firewall blocking connections</li>
          <li>CORS configuration issues</li>
          <li>Network connectivity problems</li>
        </ul>
      </div>

      <div id="connectionStatus" class="status disconnected">‚ùå Not Connected</div>

      <div class="form-group">
        <label>Server URL:</label>
        <input type="text" id="serverUrl" value="http://103.147.163.46:5090" placeholder="Server URL" />
        <button onclick="testConnection()">üîç Test Connection</button>
        <button onclick="disconnect()">‚ùå Disconnect</button>
      </div>

      <div class="form-group">
        <button onclick="testLocalhost()">üè† Test Localhost</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
      </div>

      <h3>üìä Diagnostic Log:</h3>
      <div id="log" class="log">
        Socket.IO Connection Diagnostic Tool Ready... Trying to connect to: http://103.147.163.46:5090
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      let socket = null;
      let connectionTimeout = null;

      const log = document.getElementById('log');
      const connectionStatus = document.getElementById('connectionStatus');

      function addLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        log.textContent += `[${timestamp}] ${message}\n`;
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(status, message) {
        connectionStatus.textContent = message;
        connectionStatus.className = `status ${status}`;
      }

      function testConnection() {
        const serverUrl = document.getElementById('serverUrl').value;

        if (socket) {
          socket.disconnect();
          socket = null;
        }

        addLog(`üîç Testing connection to: ${serverUrl}`);
        addLog(`üåê Checking if server is reachable...`);

        // Test basic HTTP connectivity first
        fetch(serverUrl + '/socket.io/?EIO=4&transport=polling')
          .then((response) => {
            if (response.status === 400) {
              addLog(`‚úÖ Server is reachable (Status: ${response.status})`);
              addLog(`‚ÑπÔ∏è  Status 400 is normal for Socket.IO endpoint without proper handshake`);
            } else {
              addLog(`‚úÖ HTTP connectivity test passed (Status: ${response.status})`);
            }
            startSocketConnection(serverUrl);
          })
          .catch((error) => {
            addLog(`‚ùå HTTP connectivity test failed: ${error.message}`);
            addLog(`‚ö†Ô∏è  Server might not be running or not accessible`);
            addLog(`üîÑ Trying Socket.IO connection anyway...`);
            startSocketConnection(serverUrl);
          });
      }

      function startSocketConnection(serverUrl) {
        addLog(`üîå Attempting Socket.IO connection...`);
        updateStatus('warning', '‚è≥ Connecting...');

        // Set a connection timeout
        connectionTimeout = setTimeout(() => {
          addLog(`‚è∞ Connection timeout after 10 seconds`);
          addLog(`‚ùå Possible issues:`);
          addLog(`   - Server not running`);
          addLog(`   - Port blocked by firewall`);
          addLog(`   - CORS configuration issue`);
          addLog(`   - Network connectivity problem`);
          updateStatus('disconnected', '‚ùå Connection Timeout');

          if (socket) {
            socket.disconnect();
          }
        }, 10000);

        // Check if Socket.IO client is available
        if (typeof io === 'undefined') {
          clearTimeout(connectionTimeout);
          addLog(`‚ùå Socket.IO client library not loaded!`);
          addLog(`üîß Using CDN fallback...`);
          updateStatus('disconnected', '‚ùå Socket.IO Client Missing');
          return;
        }

        try {
          socket = io(serverUrl, {
            autoConnect: true,
            reconnection: false, // Disable auto-reconnection for testing
            timeout: 5000,
            transports: ['polling', 'websocket'], // Try polling first
          });
        } catch (error) {
          clearTimeout(connectionTimeout);
          addLog(`‚ùå Failed to create Socket.IO connection: ${error.message}`);
          updateStatus('disconnected', '‚ùå Socket.IO Error');
          return;
        }

        // Connection events with detailed logging
        socket.on('connect', () => {
          clearTimeout(connectionTimeout);
          addLog(`‚úÖ Successfully connected!`);
          addLog(`üìã Socket ID: ${socket.id}`);
          addLog(`üöÄ Transport: ${socket.io.engine.transport.name}`);
          updateStatus('connected', '‚úÖ Connected Successfully');

          // Test basic functionality
          testBasicFunctionality();
        });

        socket.on('disconnect', (reason) => {
          clearTimeout(connectionTimeout);
          addLog(`‚ùå Disconnected: ${reason}`);
          updateStatus('disconnected', '‚ùå Disconnected');
        });

        socket.on('connect_error', (error) => {
          clearTimeout(connectionTimeout);
          addLog(`‚ùå Connection Error: ${error.message}`);
          addLog(`üîç Error Type: ${error.type || 'Unknown'}`);
          addLog(`üìù Description: ${error.description || 'No description'}`);
          updateStatus('disconnected', '‚ùå Connection Failed');
        });

        socket.io.on('error', (error) => {
          addLog(`‚ùå Socket.IO Error: ${error}`);
        });

        socket.on('user_joined', (data) => {
          addLog(`üëã User joined: ${data.username} in room ${data.room}`);
        });

        socket.on('new_message', (data) => {
          addLog(`üí¨ Message received: ${data.from_username}: ${data.message}`);
        });
      }

      function testBasicFunctionality() {
        addLog(`üß™ Testing basic Socket.IO functionality...`);

        // Test user setup
        socket.emit('set_user', { username: 'TestUser_' + Date.now() });

        socket.on('user_set', (data) => {
          addLog(`‚úÖ User setup successful: ${data.username}`);

          // Test room join
          socket.emit('join_room', 'test_room');
          addLog(`üè† Attempting to join test room...`);
        });

        socket.on('user_joined', (data) => {
          if (data.username.startsWith('TestUser_')) {
            addLog(`‚úÖ Room join successful!`);

            // Test message sending
            socket.emit('send_message', {
              message: 'Test message from diagnostic tool',
              room: 'test_room',
            });
            addLog(`üì§ Sending test message...`);
          }
        });

        socket.on('message_sent', (data) => {
          addLog(`‚úÖ Message sent successfully! ID: ${data.id}`);
          addLog(`üéâ All basic functionality tests passed!`);
        });
      }

      function testLocalhost() {
        document.getElementById('serverUrl').value = 'http://localhost:5090';
        testConnection();
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        if (connectionTimeout) {
          clearTimeout(connectionTimeout);
        }
        addLog(`üîå Manually disconnected`);
        updateStatus('disconnected', '‚ùå Disconnected');
      }

      function clearLog() {
        log.textContent = 'Log cleared...\n';
      }

      // Auto-start diagnostic on page load
      setTimeout(() => {
        addLog(`üöÄ Starting automatic connection test...`);
        testConnection();
      }, 1000);
    </script>
  </body>
</html>
